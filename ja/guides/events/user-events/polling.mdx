---
title: Long pollingイベント

fullyTranslated: true
---

import {RelatedLinks, MultiRelatedLinks} from "/snippets/related-links.jsx";
import {Link} from "/snippets/Link.jsx";

Boxアカウントでアクティビティのリアルタイム通知を取得するために、<Link href="/reference/options-events">`OPTIONS /events`</Link> APIのLong polling機能を使用できます。

<CodeGroup>
  ```sh cURL
  curl -i -X OPTIONS "https://api.box.com/2.0/events" \
       -H "authorization: Bearer <ACCESS_TOKEN>"
  ```

  ```typescript Node/TypeScript v10
  await client.events.getEventsWithLongPolling();
  ```

  ```python Python v10
  client.events.get_events_with_long_polling()
  ```

  ```cs .NET v10
  await client.Events.GetEventsWithLongPollingAsync();
  ```

  ```swift Swift v10
  try await client.events.getEventsWithLongPolling()
  ```

  ```java Java v10
  client.getEvents().getEventsWithLongPolling()
  ```

  ```python Python v4
  events = client.events().generate_events_with_long_polling()
  for event in events:
      print(f'Got {event.event_type} event')
  ```

  ```javascript Node v4
  client.events.getEventStream(function(err, stream) {
    if (err) {
      // handle error
    }
    stream.on('data', function(event) {
      // handle the event
    });
  });
  ```
</CodeGroup>

<Warning>
  Long pollingはUser Eventにのみ使用できます。Enterprise EventではLong pollingがサポートされません。
</Warning>

## Long polling

Long pollingでは、HTTPリクエストを開き、サーバーがレスポンスを送信するまでそのリクエストを開いたままにして、そのプロセスを何度も繰り返して更新されたレスポンスを受信します。

<Info>
  SDKには、新しいイベントに対するLong pollingにより、イベントフィードをイベントストリームに変換するためのサポートが組み込まれています。
</Info>

### Long polling URL

Long pollingを使用するには、まず、リクエストを<Link href="/reference/options-events">`OPTIONS /events`</Link> APIに送信し、Long polling URLを取得します。

```sh
curl -X OPTIONS https://api.box.com/2.0/events \
    -H "authorization: Bearer ACCESS_TOKEN"
```

```json
{
  "chunk_size": 1,
  "entries": [
    {
      "type": "realtime_server",
      "url": "http://2.realtime.services.box.net/subscribe?channel=cc807c9c4869ffb1c81a&stream_type=all",
      "ttl": 10,
      "max_retries": 10,
      "retry_timeout": 610
    }
  ]
}
```

### リアルタイムサーバー

次に、指定されたURLに`GET`リクエストを実行してイベントのリッスンを開始します。監視対象のアカウントでイベントが発生すると、`new_change`という値を持つレスポンスが送信されます。レスポンスにはその他の詳細は含まれていません。

この単一のレスポンスは、最新の既知の`stream_position`を使用して`GET /events`エンドポイントにリクエストを送信するなど、後続の処理を促すことを目的としています。

### 切断と再接続

サーバーは、このレスポンスを送信した後に接続を閉じます。この時点でアプリケーションがイベントのリッスンを再開するには、Long pollingのプロセスを繰り返す必要があります。

アプリケーションがリアルタイムサーバーに接続してもその後しばらくイベントが発生しないと、接続が閉じられ、`reconnect`という値が返されます。この状況になると、アプリケーションはプロセスを再開するために`OPTIONS /events`に対する新しい呼び出しを実行する必要があります。

### タイムアウトと再試行

`retry_timeout`で指定した秒数以内にアプリケーションがイベントを受け取らなければ、アプリケーションはリアルタイムサーバーに再接続できます。これは、ネットワークエラーが発生すると必要になる場合があります。

アプリケーションがリアルタイムサーバーに対して`GET`リクエストを送信したときに`max_retries`エラーが返された場合は、`/events` APIに対して`OPTIONS`呼び出しを実行してプロセスを再開する必要があります。

<RelatedLinks
  title="関連するAPI"
  items={[
  { label: "List user and enterprise events", href: "/reference/get-events", badge: "GET" },
  { label: "Get events long poll endpoint", href: "/reference/options-events", badge: "OPTIONS" }
]}
/>

<RelatedLinks
  title="関連するガイド"
  items={[
  { label: "Get Enterprise Events", href: "/guides/events/enterprise-events/for-enterprise", badge: "GUIDE" },
  { label: "Get User Events", href: "/guides/events/user-events/for-user", badge: "GUIDE" }
]}
/>
