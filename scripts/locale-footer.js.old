/**
 * Locale Footer Handler
 * Localizes footer link text based on current page locale
 * - On /ja/ pages: Translates footer links to Japanese
 * - On non-/ja/ pages: Keeps footer links in English
 */

(function () {
  // Footer link translations (English -> Japanese)
  const FOOTER_TRANSLATIONS = {
    "Newsletter unsubscribe": "ニュースレター配信停止",
    "Terms of Use": "利用規約",
    "Privacy Policy": "プライバシーポリシー",
    "Cookie Notification": "Cookie通知",
    Unlicense: "ライセンス解除",
    "Cookie Preferences": "Cookie設定",
  };

  // Reverse mapping (Japanese -> English)
  const REVERSE_TRANSLATIONS = Object.fromEntries(Object.entries(FOOTER_TRANSLATIONS).map(([en, ja]) => [ja, en]));

  // Function to detect current page language
  function isJapanesePage() {
    // First, check URL
    if (window.location.pathname.startsWith("/ja/")) {
      return true;
    }

    // If not in URL, check the language selector button
    const langButton = document.querySelector("#localization-select-trigger");
    if (langButton) {
      const langText = langButton.textContent.toLowerCase();
      return langText.includes("日本語") || langText.includes("japanese");
    }

    return false;
  }

  // Function to localize footer links
  function localizeFooterLinks() {
    const isJapanese = isJapanesePage();

    // Find all links in the footer element
    const footer = document.querySelector('#footer, footer');
    if (!footer) return;

    const footerLinks = footer.querySelectorAll('a[href]');

    footerLinks.forEach((link) => {
      const currentText = link.textContent.trim();

      if (isJapanese) {
        // Translate English to Japanese
        if (FOOTER_TRANSLATIONS[currentText]) {
          link.textContent = FOOTER_TRANSLATIONS[currentText];
          link.setAttribute("data-original-text", currentText);
        }
      } else {
        // Translate Japanese back to English
        if (REVERSE_TRANSLATIONS[currentText]) {
          link.textContent = REVERSE_TRANSLATIONS[currentText];
          link.setAttribute("data-original-text", currentText);
        }
        // Also check if we have the original text stored
        else if (link.hasAttribute("data-original-text")) {
          const originalText = link.getAttribute("data-original-text");
          if (FOOTER_TRANSLATIONS[originalText]) {
            link.textContent = originalText;
          }
        }
      }
    });
  }

  // Watch for dynamically added footer content
  function setupMutationObserver() {
    const observer = new MutationObserver((mutations) => {
      let shouldLocalize = false;

      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) {
            // Element node
            // Check if it's a footer or contains footer elements
            if (
              node.tagName === "FOOTER" ||
              node.classList?.toString().toLowerCase().includes("footer") ||
              node.querySelector?.('footer, [class*="footer"], [class*="Footer"]')
            ) {
              shouldLocalize = true;
            }
            // Check if it's a link being added to the footer
            if (node.tagName === "A" && node.closest('#footer, footer')) {
              shouldLocalize = true;
            }
            // Check if node contains links that are within the footer
            if (node.querySelector) {
              const footerLinks = node.querySelectorAll('a[href]');
              footerLinks.forEach((link) => {
                if (link.closest('#footer, footer')) {
                  shouldLocalize = true;
                }
              });
            }
          }
        });
      });

      if (shouldLocalize) {
        localizeFooterLinks();
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  // Initialize with retry logic for async-loaded footer
  function initializeLocalization() {
    const footer = document.querySelector('#footer, footer');
    if (footer) {
      localizeFooterLinks();
      setupMutationObserver();
      return true;
    }
    return false;
  }

  // Try to initialize immediately
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      if (!initializeLocalization()) {
        // Footer not found, retry with interval
        const retryInterval = setInterval(() => {
          if (initializeLocalization()) {
            clearInterval(retryInterval);
          }
        }, 100);
        // Stop retrying after 5 seconds
        setTimeout(() => clearInterval(retryInterval), 5000);
      }
    });
  } else {
    if (!initializeLocalization()) {
      // Footer not found, retry with interval
      const retryInterval = setInterval(() => {
        if (initializeLocalization()) {
          clearInterval(retryInterval);
        }
      }, 100);
      // Stop retrying after 5 seconds
      setTimeout(() => clearInterval(retryInterval), 5000);
    }
  }

  // Re-localize on language change (if language selector is used)
  // This handles cases where the user switches language without page reload
  const langObserver = new MutationObserver(() => {
    localizeFooterLinks();
  });

  // Watch for changes to the language selector
  const checkForLangSelector = setInterval(() => {
    const langButton = document.querySelector("#localization-select-trigger");
    if (langButton) {
      langObserver.observe(langButton, {
        childList: true,
        characterData: true,
        subtree: true,
      });
      clearInterval(checkForLangSelector);
    }
  }, 500);

  // Clear the interval after 10 seconds to avoid running indefinitely
  setTimeout(() => clearInterval(checkForLangSelector), 10000);
})();
